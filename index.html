<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Autorizaciones Solidarios FD</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    header {
      background: #334155;
      color: white;
      padding: 10px 20px;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 15px;
      background: #e2e8f0;
      padding: 10px;
    }
    nav button {
      background: #64748b;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
    }
    nav button:hover {
      background: #475569;
    }
    .panel {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px auto;
      width: 90%;
      max-width: 700px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, select, textarea {
      width: 100%;
      margin: 6px 0;
      padding: 6px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
    }
    .small {
      padding: 5px 10px;
      font-size: 0.9em;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
      padding: 8px;
      border-radius: 8px;
      margin: 4px 0;
    }
    .muted {
      color: #6b7280;
      font-size: 0.9em;
    }
    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>
  <header><h2>üìå Autorizaciones Solidarios FD</h2></header>

  <nav>
    <button onclick="panelEventos()">Eventos</button>
    <button onclick="panelAutorizaciones()">Autorizaciones</button>
    <button onclick="panelProfesores()">Profesores</button>
  </nav>

  <div id="panelArea"></div>

  <script>
    emailjs.init("cWbA2V4zKpB7X6iWd"); // Tu Public Key de EmailJS

    const KEY_EVENTOS = "solidarios_eventos";
    const KEY_PROFS = "solidarios_profesores";

    function saveLocal(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }
    function loadLocal(key, def) {
      return JSON.parse(localStorage.getItem(key) || JSON.stringify(def));
    }

    function renderEventosLateral() {} // (placeholder)

    /* ---------------------------
       PANEL: EVENTOS (franja de d√≠as)
    --------------------------- */
    async function panelEventos(){
      const container = document.getElementById("panelArea");
      const eventos = loadLocal(KEY_EVENTOS, []);
      container.innerHTML = `
        <div class="panel">
          <h3>Gestionar Eventos</h3>
          <form id="formEvento">
            <input type="text" id="evName" placeholder="Nombre del evento" required />
            <label>Franja de d√≠as autorizada:</label>
            <div style="display:flex;gap:6px;">
              <input type="date" id="evDateIni" required />
              <span>a</span>
              <input type="date" id="evDateFin" required />
            </div>
            <label>Franja horaria:</label>
            <div style="display:flex;gap:6px;">
              <input type="time" id="evIni" required />
              <input type="time" id="evFin" required />
            </div>
            <button type="submit" class="small">Agregar evento</button>
          </form>
          <h4 style="margin-top:12px;">Eventos existentes</h4>
          <div id="listaEventos"></div>
        </div>
      `;

      const form = document.getElementById("formEvento");
      form.onsubmit = e => {
        e.preventDefault();
        let arr = loadLocal(KEY_EVENTOS, []);
        arr.push({
          nombre: form.evName.value.trim(),
          fecha_ini: form.evDateIni.value,
          fecha_fin: form.evDateFin.value,
          ini: form.evIni.value,
          fin: form.evFin.value,
          id: Date.now()
        });
        saveLocal(KEY_EVENTOS, arr);
        panelEventos();
      };

      const lista = document.getElementById("listaEventos");
      lista.innerHTML = "";
      eventos.forEach(ev => {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div>
            <b>${ev.nombre}</b>
            <div class="muted">${ev.fecha_ini} ‚Üí ${ev.fecha_fin} (${ev.ini} a ${ev.fin})</div>
          </div>
          <div><button class="small" onclick="delEvento(${ev.id})">‚ùå Borrar</button></div>
        `;
        lista.appendChild(div);
      });
    }

    function delEvento(id){
      let arr = loadLocal(KEY_EVENTOS, []);
      arr = arr.filter(e => e.id !== id);
      saveLocal(KEY_EVENTOS, arr);
      panelEventos();
    }

    /* ---------------------------
       PANEL: PROFESORES
    --------------------------- */
    async function panelProfesores(){
      const container = document.getElementById("panelArea");
      const profs = loadLocal(KEY_PROFS, [
        {nombre:"Juan Jos√©", email:"juanjose@iepgroup.es"},
        {nombre:"Susana de Diego", email:"susana.dediego@iepgroup.es"},
        {nombre:"Elena Covadonga", email:"elena.covadonga@iepgroup.es"},
        {nombre:"Elena Ovejero", email:"elena.ovejero@iepgroup.es"},
        {nombre:"Jos√© Luis Arriaga", email:"jose.luis.arriaga@iepgroup.es"},
        {nombre:"Ascensi√≥n Li√©bana", email:"ascension.liebana@iepgroup.es"},
        {nombre:"Ana L√≥pez", email:"ana.lopez@iepgroup.es"},
        {nombre:"Jos√© Luis Herrero", email:"joseluis.herrero@iepgroup.es"},
        {nombre:"Antonio Li√©bana", email:"antonio.liebana@iepgroup.es"},
        {nombre:"M√≥nica Ju√°rez", email:"monica.juarez@iepgroup.es"},
        {nombre:"√ìscar Partida", email:"oscar.partida@iepgroup.es"}
      ]);
      container.innerHTML = `
        <div class="panel">
          <h3>Profesores</h3>
          <form id="formProf">
            <input type="text" id="profName" placeholder="Nombre del profesor" required />
            <input type="email" id="profEmail" placeholder="Correo electr√≥nico" required />
            <button type="submit" class="small">Agregar</button>
          </form>
          <div id="listaProfs"></div>
        </div>
      `;
      const form = document.getElementById("formProf");
      form.onsubmit = e => {
        e.preventDefault();
        let arr = loadLocal(KEY_PROFS, []);
        arr.push({ nombre: form.profName.value.trim(), email: form.profEmail.value.trim() });
        saveLocal(KEY_PROFS, arr);
        panelProfesores();
      };

      const lista = document.getElementById("listaProfs");
      lista.innerHTML = "";
      profs.forEach((p,i) => {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `<div>${p.nombre}<div class='muted'>${p.email}</div></div>
        <div><button class="small" onclick="delProf(${i})">‚ùå</button></div>`;
        lista.appendChild(div);
      });
    }

    function delProf(i){
      let arr = loadLocal(KEY_PROFS, []);
      arr.splice(i,1);
      saveLocal(KEY_PROFS, arr);
      panelProfesores();
    }

    /* ---------------------------
       PANEL: AUTORIZACIONES
    --------------------------- */
    async function panelAutorizaciones(){
      const alumnos = [
        "JUAN ALCAIDE ORTEGA","IGNACIO ALONSO FERN√ÅNDEZ","ANA APARICIO DE DIEGO",
        "BLANCA AR√çAS LOMAS","NOA ASENSIO LEGIDO","ISABELLA BENTO RUIZ",
        "EMMA BERM√öDEZ L√ìPEZ","cyan blaise velasquez","Asier Bocardo Melguizo",
        "SOF√çA BRAVO TEJERO","MAR SARAY C√ÅCERES FLORES","ARIADNE CALDER√ìN P√âREZ",
        "DANIELA CA√ëETE L√ìPEZ","MAR√çA COBOS BENEDICTO","IVAN CORREIA NARROS",
        "ALEJANDRO DE BLAS L√ìPEZ-EGEA","ADRI√ÅN DELGADO GONZALEZ","PABLO DUY D√çAZ SANT√çN",
        "SOF√çA D√çAZ-PACHE ROJAS","VEGA EGEA ARO","SARA FERN√ÅNDEZ BUITRAGO",
        "RUTH FERN√ÅNDEZ GONZALO","C√©sar Fern√°ndez Zarco","MARCOS GARC√çA BARTOLOM√â",
        "BLANCA GARC√çA ESTEBAN","DANIELA GARC√çA G√ìMEZ","Hugo Garc√≠a Gonz√°lez",
        "V√çCTOR GARC√çA RAM√çREZ","MAR√çA G√ìMEZ CARMONA","M√ìNICA GUTI√âRREZ ROM√ÅN",
        "MAR√çA HERR√ÅEZ MART√çNEZ","EMMA HERRERO BENITO","EMMA HUERTAS L√ìPEZ",
        "SARA LEONARDO GARC√çA","Aini Li","Dimas L√≥pez","ELENA MART√çNEZ BA√ë√ìN",
        "NOA MART√çNEZ HURTADO","DANIEL ORTE G√ìMEZ","GUILLERMO PALACIOS ASPIAZU (guiso)",
        "LUC√çA P√âREZ GALIANA","MARCELA RAMOS GUD√çN","LIA RODR√çGUEZ SIERRA",
        "ANDR√âS ROMERO OCHOA","CLAUDIA JING XIAN RUAN","Isabela RUBIO PARRA",
        "DOMENIKOS SALAZAR BALLI","PRITHIKA THIRUNAVUKKARASU","SOF√çA TORRES FERN√ÅNDEZ",
        "ERIKA V√ÅZQUEZ S√ÅNCHEZ","CLAUDIA VERA CANTALAPIEDRA","CARLA VIVAR DEL CASTILLO",
        "LUCAS WILT ESCRIBANO","Angela Xia","MINGHAO XU","WAN YUE YANG","YINGZHAO ZHOU"
      ];
      const eventos = loadLocal(KEY_EVENTOS, []);
      const profs = loadLocal(KEY_PROFS, []);
      const container = document.getElementById("panelArea");

      container.innerHTML = `
        <div class="panel">
          <h3>Enviar Autorizaciones</h3>
          <label>Selecciona evento:</label>
          <select id="selEvento">
            <option value="">-- Selecciona --</option>
            ${eventos.map(e=>`<option value="${e.id}">${e.nombre} (${e.fecha_ini}‚Üí${e.fecha_fin})</option>`).join("")}
          </select>
          <label>Selecciona alumnos:</label>
          <select id="selAlumnos" multiple size="8">${alumnos.map(a=>`<option>${a}</option>`).join("")}</select>
          <label>Selecciona profesores:</label>
          <select id="selProfs" multiple size="8">${profs.map(p=>`<option value="${p.email}">${p.nombre}</option>`).join("")}</select>
          <button id="btnSend" class="btn" style="margin-top:10px;">Enviar autorizaciones</button>
          <div id="res"></div>
        </div>
      `;

      document.getElementById("btnSend").onclick = async ()=>{
        const evento = eventos.find(e=>e.id == document.getElementById("selEvento").value);
        if(!evento) return alert("Selecciona un evento");
        const selAl = Array.from(document.getElementById("selAlumnos").selectedOptions).map(o=>o.text);
        const selPr = Array.from(document.getElementById("selProfs").selectedOptions).map(o=>({email:o.value,nombre:o.text}));
        if(selAl.length===0 || selPr.length===0) return alert("Selecciona al menos un alumno y un profesor.");

        const serviceId = "service_eb2pt87";
        const templateId = "template_0z24xrk";
        const promises = [];

        selAl.forEach(alumno=>{
          selPr.forEach(prof=>{
            const contenido = `
AUTORIZACI√ìN DE SALIDA DE CLASE

El grupo SOLIDARIOS del centro educativo comunica a los profesores y responsables que el/la alumno/a indicado a continuaci√≥n queda autorizado/a para ausentarse de su clase con motivo de la participaci√≥n en una actividad solidaria organizada dentro del marco de las acciones de voluntariado escolar.

Nombre del alumno/a: ${alumno}
Curso / Grupo: (indicar si procede)
Actividad: ${evento.nombre}
D√≠as autorizados: del ${evento.fecha_ini} al ${evento.fecha_fin}
Franja horaria autorizada: ${evento.ini} a ${evento.fin}

Durante este tiempo, el/la alumno/a estar√° bajo la supervisi√≥n de los responsables de la actividad solidaria y se compromete a reincorporarse a sus clases habituales una vez finalizada la misma.

Este documento tiene validez √∫nicamente para el periodo y franja horaria se√±alados, y deber√° presentarse al profesor/a correspondiente al inicio de cada salida.

üìå ALUMNOS SOLIDARIOS DE FD
            `.trim();

            const templateParams = {
              to_email: prof.email,
              nombre: alumno,
              clase: "",
              evento: evento.nombre,
              fecha_ini: evento.fecha_ini,
              fecha_fin: evento.fecha_fin,
              ini: evento.ini,
              fin: evento.fin,
              contenido: contenido,
              subject: `Autorizaci√≥n ‚Äî ${alumno} (${evento.nombre}) del ${evento.fecha_ini} al ${evento.fecha_fin}`
            };

            promises.push(
              emailjs.send(serviceId, templateId, templateParams)
                .then(()=>({status:"ok", alumno, prof:prof.email}))
                .catch(err=>({status:"err", alumno, prof:prof.email, err}))
            );
          });
        });

        const results = await Promise.all(promises);
        const ok = results.filter(r=>r.status==="ok").length;
        const fail = results.length - ok;
        document.getElementById("res").innerHTML = `<p>‚úÖ Enviados: ${ok} &nbsp;&nbsp; ‚ùå Fallidos: ${fail}</p>`;
      };
    }

    panelEventos(); // vista inicial
  </script>
</body>
</html>





