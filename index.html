<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alumnos Solidarios</title>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
(function(){
  emailjs.init("nXxJ4Ujpxo56o0BUT"); // Public Key
})();
</script>

<style>
body, html {margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:linear-gradient(135deg, red, yellow, orange);}
header {display:flex; justify-content:space-between; padding:15px 25px; font-weight:bold; color:black; font-size:20px; background:rgba(255,255,255,0.7);}
.login-container {height:calc(100% - 60px); display:flex; justify-content:center; align-items:center;}
.card {background:white; padding:20px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.3); width:320px; max-width:90%;}
.card input, .card button, select {width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc;}
.card button {background:black; color:white; cursor:pointer;}
.hidden {display:none;}
.app {padding:20px; display:flex; flex-wrap:wrap;}
#left {flex:1; min-width:250px; background:rgba(255,255,255,0.8); padding:15px; border-radius:10px; margin-right:20px;}
#right {flex:2; min-width:300px; display:flex; flex-direction:column; align-items:center;}
.btn {padding:20px; margin:10px; border:none; border-radius:10px; cursor:pointer; font-size:18px; width:80%; background:black; color:white;}
.btn:hover {background:#333;}
.panel {margin-top:20px; background:white; padding:15px; border-radius:10px; width:90%;}
.list-item {border-bottom:1px solid #ccc; padding:5px; display:flex; justify-content:space-between; flex-wrap:wrap;}
@media (max-width:768px){.app{flex-direction:column;} #left{margin-right:0; margin-bottom:20px;}}
</style>
</head>
<body>
<header>
  <div>Voluntariado</div>
  <div>Alumnos Solidarios</div>
</header>

<div id="login" class="login-container">
  <div class="card">
    <h2>Iniciar Sesión</h2>
    <form id="loginForm">
      <input type="text" id="loginUser" placeholder="Usuario" required>
      <input type="password" id="loginPass" placeholder="Contraseña" required>
      <button type="submit">Entrar</button>
    </form>
  </div>
</div>

<div id="app" class="hidden">
  <h2 id="welcome" style="margin-left:20px;"></h2>
  <div class="app">
    <div id="left">
      <h3>Próximos Eventos</h3>
      <div id="listaEventosLateral"></div>
    </div>
    <div id="right">
      <div id="adminButtons" class="hidden">
        <button class="btn" onclick="panelUsuarios()">Usuarios</button>
        <button class="btn" onclick="panelProfesores()">Profesores</button>
        <button class="btn" onclick="panelEventos()">Eventos</button>
        <button class="btn" onclick="panelChatAdmin()">Chat</button>
        <button class="btn" onclick="panelAutorizaciones()">Autorizaciones</button>
      </div>
      <div id="userButtons" class="hidden">
        <button class="btn" onclick="panelEventosUsuario()">Próximos eventos</button>
        <button class="btn" onclick="panelChatUsuario()">Chat con Admin</button>
      </div>
      <div id="panelArea"></div>
      <button onclick="logout()" class="btn" style="background:red;margin-top:20px;">Cerrar sesión</button>
    </div>
  </div>
</div>

<script>
const ADMINS=["admin1","admin2"];
const ADMIN_PASS="Solidarios25";
let currentUser=null;
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwhLwPiRtBgFpJR01Cgf4sDcBR1ggmO6zNmp0i5ZkDXBcp2p6PpK2b_wRKYkcI1uGia/exec";

// --- Funciones de Google Sheets ---
async function load(k){
  try{
    let res = await fetch(`${SCRIPT_URL}?action=load&key=${encodeURIComponent(k)}`);
    let data = await res.json();
    return data || [];
  }catch(e){console.error("Error cargando datos:", e); return [];}
}
async function save(k,v){
  try{
    await fetch(SCRIPT_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:"save", key:k, value:v})
    });
  }catch(e){console.error("Error guardando datos:", e);}
}

// --- LOGIN ---
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const u=document.getElementById("loginUser").value.trim();
  const p=document.getElementById("loginPass").value.trim();
  if(ADMINS.includes(u)&&p===ADMIN_PASS){
    currentUser={username:u,role:"Admin"};
    await startApp();
  } else {
    let usuarios=await load("usuarios");
    let user=usuarios.find(x=>x.user===u&&x.pass===p);
    if(user){currentUser={...user,role:"User"}; await startApp();}
    else alert("Usuario o contraseña incorrectos");
  }
});

async function startApp(){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  const displayName = currentUser.role==="Admin"?currentUser.username:(currentUser.nombre||currentUser.user);
  document.getElementById("welcome").innerText="Bienvenido, "+displayName;
  document.getElementById("adminButtons").classList.toggle("hidden", currentUser.role!=="Admin");
  document.getElementById("userButtons").classList.toggle("hidden", currentUser.role==="Admin");
  await renderEventosLateral();
  document.getElementById("panelArea").innerHTML="";
}
function logout(){location.reload();}

// --- Panel Usuarios ---
async function panelUsuarios(){
  const c=document.getElementById("panelArea");
  const usuarios=await load("usuarios");
  c.innerHTML=`
  <div class="panel">
    <h3>Gestionar Usuarios</h3>
    <form id="formUser">
      <input type="text" id="newUser" placeholder="Usuario" required>
      <input type="password" id="newPass" placeholder="Contraseña" required>
      <input type="text" id="nombre" placeholder="Nombre completo" required>
      <select id="clase">
        ${["1ºESO","2ºESO","3ºESO","4ºESO"].map(curso=>Array.from({length:curso==="4ºESO"?4:5},(_,i)=>`${curso} ${String.fromCharCode(65+i)}`).map(op=>`<option>${op}</option>`).join("")).join("")}
      </select>
      <button type="submit">Agregar</button>
    </form>
    <h4>Usuarios existentes</h4>
    <div id="listaUsuarios"></div>
  </div>`;
  const form=document.getElementById("formUser");
  form.onsubmit=async e=>{
    e.preventDefault();
    let arr=await load("usuarios");
    arr.push({user:form.newUser.value, pass:form.newPass.value, nombre:form.nombre.value, clase:form.clase.value});
    await save("usuarios", arr);
    await panelUsuarios();
  }
  const lista=document.getElementById("listaUsuarios");
  usuarios.forEach((u,i)=>{
    let div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`${u.nombre} (${u.user}, ${u.clase}) <button onclick="delUser(${i})">❌</button>`;
    lista.appendChild(div);
  });
}
async function delUser(i){
  let u=await load("usuarios");
  u.splice(i,1);
  await save("usuarios", u);
  await panelUsuarios();
}

// --- Panel Profesores ---
async function panelProfesores(){
  const c=document.getElementById("panelArea");
  const profs=await load("profesores");
  c.innerHTML=`
  <div class="panel">
    <h3>Gestionar Profesores</h3>
    <form id="formProf">
      <input type="text" id="profName" placeholder="Nombre Profesor" required>
      <input type="email" id="profMail" placeholder="Correo Profesor" required>
      <button type="submit">Agregar</button>
    </form>
    <h4>Profesores registrados</h4>
    <div id="listaProfs"></div>
  </div>`;
  const form=document.getElementById("formProf");
  form.onsubmit=async e=>{
    e.preventDefault();
    let arr=await load("profesores");
    arr.push({nombre:form.profName.value,email:form.profMail.value});
    await save("profesores",arr);
    await panelProfesores();
  }
  const lista=document.getElementById("listaProfs");
  profs.forEach((p,i)=>{
    let div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`${p.nombre} (${p.email}) <button onclick="delProf(${i})">❌</button>`;
    lista.appendChild(div);
  });
}
async function delProf(i){
  let arr=await load("profesores");
  arr.splice(i,1);
  await save("profesores",arr);
  await panelProfesores();
}

// --- Panel Eventos (Admin) ---
async function panelEventos(){
  const c=document.getElementById("panelArea");
  const eventos=await load("eventos");
  c.innerHTML=`
  <div class="panel">
    <h3>Gestionar Eventos</h3>
    <form id="formEvento">
      <input type="text" id="evName" placeholder="Nombre evento" required>
      <input type="time" id="evIni" required> a <input type="time" id="evFin" required>
      <button type="submit">Agregar</button>
    </form>
    <h4>Eventos existentes</h4>
    <div id="listaEventos"></div>
  </div>`;
  const form=document.getElementById("formEvento");
  form.onsubmit=async e=>{
    e.preventDefault();
    let arr=await load("eventos");
    arr.push({nombre:form.evName.value,ini:form.evIni.value,fin:form.evFin.value,asistencias:[]});
    await save("eventos",arr);
    await panelEventos();
    await renderEventosLateral();
  }
  const lista=document.getElementById("listaEventos");
  lista.innerHTML="";
  eventos.forEach((ev,i)=>{
    let div=document.createElement("div");
    div.className="list-item";
    const alumnos=(ev.asistencias||[]).map(a=>`${a.nombre} (${a.clase}) → ${a.resp}`).join("<br>");
    div.innerHTML=`<b>${ev.nombre}</b> ${ev.ini}-${ev.fin}<br>${alumnos||"Sin respuestas"} <button onclick="delEvento(${i})">❌</button>`;
    lista.appendChild(div);
  });
}
async function delEvento(i){
  let e=await load("eventos");
  e.splice(i,1);
  await save("eventos",e);
  await panelEventos();
  await renderEventosLateral();
}

// --- Panel Eventos Usuario ---
async function panelEventosUsuario(){
  const c=document.getElementById("panelArea");
  const eventos=await load("eventos");
  const profs=await load("profesores");
  c.innerHTML="<div class='panel'><h3>Próximos eventos</h3></div>";
  eventos.forEach((ev,i)=>{
    let div=document.createElement("div");
    div.className="list-item";
    let options = profs.length ? profs.map(p=>`<option value="${p.email}">${p.nombre}</option>`).join("") : `<option value="">(Sin profesores)</option>`;
    div.innerHTML=`${ev.nombre} ${ev.ini}-${ev.fin}
      <select id="profSel${i}">${options}</select>
      <button onclick="responder(${i},'Sí')">✅ Sí</button>
      <button onclick="responder(${i},'No')">❌ No</button>`;
    c.firstElementChild.appendChild(div);
  });
}
async function responder(i,r){
  let eventos=await load("eventos");
  let ev=eventos[i];
  ev.asistencias=(ev.asistencias||[]).filter(a=>a.user!==currentUser.user);
  let sel=document.getElementById("profSel"+i);
  let profEmail=sel?sel.value:"";
  ev.asistencias.push({user:currentUser.user,nombre:currentUser.nombre,clase:currentUser.clase,resp:r,profEmail});
  await save("eventos",eventos);
  alert("Respuesta guardada");
  await panelEventosUsuario();
  await renderEventosLateral();
}

// --- Render Lateral ---
async function renderEventosLateral(){
  let eventos=await load("eventos");
  let cont=document.getElementById("listaEventosLateral");
  cont.innerHTML="";
  eventos.forEach(ev=>{
    let div=document.createElement("div");
    div.textContent=`${ev.nombre} (${ev.ini}-${ev.fin})`;
    cont.appendChild(div);
  });
}

// --- Panel Chat Usuario ---
async function panelChatUsuario(){
  const c=document.getElementById("panelArea");
  let msgs=await load("chat_"+currentUser.user);
  c.innerHTML=`
  <div class="panel">
    <h3>Chat con Admin</h3>
    <div id="msgs" style="border:1px solid #ccc; max-height:200px; overflow:auto; margin:5px;"></div>
    <form id="formChat">
      <input type="text" id="msgTxt" placeholder="Mensaje">
      <button type="submit">Enviar</button>
    </form>
  </div>`;
  let msgsDiv=c.querySelector("#msgs");
  msgsDiv.innerHTML="";
  msgs.forEach(m=>{ let p=document.createElement("p"); p.textContent=m; msgsDiv.appendChild(p); });
  c.querySelector("#formChat").onsubmit=async e=>{
    e.preventDefault();
    let arr=await load("chat_"+currentUser.user);
    arr.push((currentUser.user||"usuario")+": "+c.querySelector("#msgTxt").value);
    await save("chat_"+currentUser.user,arr);
    await panelChatUsuario();
  }
}

// --- Panel Chat Admin ---
async function panelChatAdmin(){
  const c=document.getElementById("panelArea");
  const usuarios=await load("usuarios");
  c.innerHTML="<div class='panel'><h3>Chats de usuarios</h3></div>";
  usuarios.forEach(u=>{
    let div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`${u.nombre} (${u.user}) <button onclick="abrirChatAdmin('${u.user}')">Abrir chat</button>`;
    c.firstElementChild.appendChild(div);
  });
}
async function abrirChatAdmin(user){
  const c=document.getElementById("panelArea");
  let msgs=await load("chat_"+user);
  c.innerHTML=`
  <div class="panel">
    <h3>Chat con ${user}</h3>
    <div id="msgs" style="border:1px solid #ccc; max-height:200px; overflow:auto; margin:5px;"></div>
    <form id="formChat">
      <input type="text" id="msgTxt" placeholder="Mensaje">
      <button type="submit">Enviar</button>
    </form>
  </div>`;
  let msgsDiv=c.querySelector("#msgs");
  msgsDiv.innerHTML="";
  msgs.forEach(m=>{ let p=document.createElement("p"); p.textContent=m; msgsDiv.appendChild(p); });
  c.querySelector("#formChat").onsubmit=async e=>{
    e.preventDefault();
    let arr=await load("chat_"+user);
    arr.push("Admin: "+c.querySelector("#msgTxt").value);
    await save("chat_"+user,arr);
    await abrirChatAdmin(user);
  }
}

// --- Panel Autorizaciones ---
async function panelAutorizaciones(){
  const c=document.getElementById("panelArea");
  let eventos=await load("eventos");
  c.innerHTML=`<div class="panel"><h3>Autorizaciones pendientes</h3></div>`;
  let panel=c.querySelector(".panel");
  eventos.forEach((ev,i)=>{
    if(ev.asistencias && ev.asistencias.length>0){
      let div=document.createElement("div");
      div.className="list-item";
      let alumnos=ev.asistencias.map(a=>`${a.nombre} (${a.clase}) → ${a.resp} ${a.resp==="Sí"?`<button onclick="enviarAutorizacion('${a.nombre}','${a.clase}','${ev.ini}','${ev.fin}','${a.profEmail}')">✉️ Autorizar</button>`:""}`).join("<br>");
      div.innerHTML=`<b>${ev.nombre}</b> ${ev.ini}-${ev.fin}<br>${alumnos}`;
      panel.appendChild(div);
    }
  });
}

function enviarAutorizacion(nombre,clase,ini,fin,profMail){
  emailjs.send("service_eb2pt87","template_0z24xrk",{
    to_email: profMail,
    nombre: nombre,
    clase: clase,
    ini: ini,
    fin: fin
  }).then(()=>alert("✅ Autorización enviada automáticamente a "+profMail), err=>alert("❌ Error al enviar: "+JSON.stringify(err)));
}
</script>
</body>
</html>
