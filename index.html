<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alumnos Solidarios ‚Äî Admin</title>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){
    emailjs.init("nXxJ4Ujpxo56o0BUT"); // Public Key (igual que antes)
  })();
</script>

<style>
  body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:linear-gradient(135deg, red, yellow, orange); }
  header { display:flex; justify-content:space-between; padding:15px 25px; font-weight:bold; color:black; font-size:20px; background:rgba(255,255,255,0.8); }
  .login-container { height:calc(100% - 60px); display:flex; justify-content:center; align-items:center; }
  .card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.3); width:360px; max-width:95%; }
  .card input, .card button, select, textarea { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  .card button { background:black; color:white; cursor:pointer; border:none; }
  .hidden { display:none; }
  .app { padding:20px; display:flex; flex-wrap:wrap; }
  #left { flex:1; min-width:260px; background:rgba(255,255,255,0.9); padding:15px; border-radius:10px; margin-right:20px; }
  #right { flex:2; min-width:340px; display:flex; flex-direction:column; align-items:center; }
  .btn { padding:14px; margin:8px; border:none; border-radius:10px; cursor:pointer; font-size:16px; width:85%; background:black; color:white; }
  .btn:hover { background:#333; }
  .panel { margin-top:20px; background:white; padding:15px; border-radius:10px; width:95%; box-sizing:border-box; }
  .list-item { border-bottom:1px solid #ccc; padding:8px; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; }
  .muted { color:#666; font-size:14px; }
  @media (max-width:768px){ .app{ flex-direction:column; } #left{ margin-right:0; margin-bottom:20px; } }
  .small { font-size:13px; padding:6px 8px; }
  .checkbox-grid { display:grid; gap:6px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
</style>
</head>
<body>
<header>
  <div>Voluntariado</div>
  <div>Alumnos Solidarios ‚Äî Admin</div>
</header>

<!-- LOGIN -->
<div id="login" class="login-container">
  <div class="card">
    <h2>Iniciar Sesi√≥n (Admin)</h2>
    <form id="loginForm">
      <input type="text" id="loginUser" placeholder="Usuario (admin1 / admin2)" required />
      <input type="password" id="loginPass" placeholder="Contrase√±a" required />
      <button type="submit">Entrar</button>
    </form>
    <p class="muted">Usuarios admin: <b>admin1</b>, <b>admin2</b>. Contrase√±a: <b>Solidarios25</b></p>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h2 id="welcome" style="margin-left:20px;"></h2>
  <div class="app">
    <div id="left">
      <h3>Pr√≥ximos Eventos</h3>
      <div id="listaEventosLateral" class="muted"></div>
      <div class="panel" style="margin-top:12px;">
        <h3>Profesores (panel)</h3>
        <div id="panelProfesoresContainer"></div>
        <hr>
        <h4>A√±adir profesor</h4>
        <form id="formAddProfesor">
          <input type="text" id="profName" placeholder="Nombre profesor" required />
          <input type="email" id="profEmail" placeholder="Correo profesor" required />
          <button type="submit" class="small">Agregar profesor</button>
        </form>
      </div>
    </div>

    <div id="right">
      <div id="adminButtons">
        <button class="btn" onclick="panelEventos()">Eventos</button>
        <button class="btn" onclick="panelProfesores()">Profesores</button>
        <button class="btn" onclick="panelAutorizaciones()">Autorizaciones</button>
      </div>

      <div id="panelArea" style="width:100%;"></div>

      <button onclick="logout()" class="btn" style="background:red;margin-top:20px;">Cerrar sesi√≥n</button>
    </div>
  </div>
</div>

<script>
/* ------------------------------------------------------------
   CONFIGURACI√ìN EDITABLE ‚Äî aqu√≠ puedes pegar/editar listas:
   ------------------------------------------------------------ */

// üîß EDITA AQU√ç: Lista de alumnos (f√°cil de editar)
const ALUMNOS = [
"JUAN ALCAIDE ORTEGA",
"IGNACIO ALONSO FERN√ÅNDEZ",
"ANA APARICIO DE DIEGO",
"BLANCA AR√çAS LOMAS",
"NOA ASENSIO LEGIDO",
"ISABELLA BENTO RUIZ",
"EMMA BERM√öDEZ L√ìPEZ",
"cyan blaise velasquez",
"Asier Bocardo Melguizo",
"SOF√çA BRAVO TEJERO",
"MAR SARAY C√ÅCERES FLORES",
"ARIADNE CALDER√ìN P√âREZ",
"DANIELA CA√ëETE L√ìPEZ",
"MAR√çA COBOS BENEDICTO",
"IVAN CORREIA NARROS",
"ALEJANDRO DE BLAS L√ìPEZ-EGEA",
"ADRI√ÅN DELGADO GONZALEZ",
"PABLO DUY D√çAZ SANT√çN",
"SOF√çA D√çAZ-PACHE ROJAS",
"VEGA EGEA ARO",
"SARA FERN√ÅNDEZ BUITRAGO",
"RUTH FERN√ÅNDEZ GONZALO",
"C√©sar Fern√°ndez Zarco",
"MARCOS GARC√çA BARTOLOM√â",
"BLANCA GARC√çA ESTEBAN",
"DANIELA GARC√çA G√ìMEZ",
"Hugo Garc√≠a Gonz√°lez",
"V√çCTOR GARC√çA RAM√çREZ",
"MAR√çA G√ìMEZ CARMONA",
"M√ìNICA GUTI√âRREZ ROM√ÅN",
"MAR√çA HERR√ÅEZ MART√çNEZ",
"EMMA HERRERO BENITO",
"EMMA HUERTAS L√ìPEZ",
"SARA LEONARDO GARC√çA",
"Aini Li",
"Dimas L√≥pez",
"ELENA MART√çNEZ BA√ë√ìN",
"NOA MART√çNEZ HURTADO",
"DANIEL ORTE G√ìMEZ",
"GUILLERMO PALACIOS ASPIAZU (guiso)",
"LUC√çA P√âREZ GALIANA",
"MARCELA RAMOS GUD√çN",
"LIA RODR√çGUEZ SIERRA",
"ANDR√âS ROMERO OCHOA",
"CLAUDIA JING XIAN RUAN",
"Isabela RUBIO PARRA",
"DOMENIKOS SALAZAR BALLI",
"PRITHIKA THIRUNAVUKKARASU",
"SOF√çA TORRES FERN√ÅNDEZ",
"ERIKA V√ÅZQUEZ S√ÅNCHEZ",
"CLAUDIA VERA CANTALAPIEDRA",
"CARLA VIVAR DEL CASTILLO",
"LUCAS WILT ESCRIBANO",
"Angela Xia",
"MINGHAO XU",
"WAN YUE YANG",
"YINGZHAO ZHOU"
];

// üîß EDITA AQU√ç: Lista inicial de profesores (nombre y email). Tambi√©n editable desde el panel.
const INITIAL_PROFESORES = [
  { nombre: "Juan Jos√©", email: "juanjose@iepgroup.es" },
  { nombre: "Susana de Diego", email: "susana.dediego@iepgroup.es" },
  { nombre: "Elena Covadonga", email: "elena.covadonga@iepgroup.es" },
  { nombre: "Elena Ovejero", email: "elena.ovejero@iepgroup.es" },
  { nombre: "Jos√© Luis Arriaga", email: "jose.luis.arriaga@iepgroup.es" },
  { nombre: "Ascensi√≥n Li√©bana", email: "ascension.liebana@iepgroup.es" },
  { nombre: "Ana L√≥pez", email: "ana.lopez@iepgroup.es" },
  { nombre: "Jos√© Luis Herrero", email: "joseluis.herrero@iepgroup.es" },
  { nombre: "Antonio Li√©bana", email: "antonio.liebana@iepgroup.es" },
  { nombre: "M√≥nica Ju√°rez", email: "monica.juarez@iepgroup.es" },
  { nombre: "√ìscar Partida", email: "oscar.partida@iepgroup.es" }
];

/* ------------------------------------------------------------
   FIN CONFIGURACI√ìN
   ------------------------------------------------------------ */

// ADMIN CREDENTIALS (sin tocar)
const ADMINS = ["admin1","admin2"];
const ADMIN_PASS = "Solidarios25";

// localStorage keys
const KEY_PROFES = "as_profesores_v1";
const KEY_EVENTOS = "as_eventos_v1";

// --- Utilities: localStorage wrapper ---
function loadLocal(key, fallback){
  try {
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  } catch(e){ console.error("loadLocal error",e); return fallback; }
}
function saveLocal(key, value){
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch(e){ console.error("saveLocal error",e); }
}

// On first run populate professors from initial list if none saved
if(!loadLocal(KEY_PROFES, null)){
  saveLocal(KEY_PROFES, INITIAL_PROFESORES);
}
if(!loadLocal(KEY_EVENTOS, null)){
  saveLocal(KEY_EVENTOS, []); // empty events initially
}

// --- LOGIN ---
let currentUser = null;
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value.trim();
  if(ADMINS.includes(u) && p === ADMIN_PASS){
    currentUser = { username: u, role: "Admin" };
    startApp();
  } else {
    alert("Usuario o contrase√±a incorrectos");
  }
});

function logout(){
  location.reload();
}

async function startApp(){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  document.getElementById("welcome").innerText = "Bienvenido, " + currentUser.username;
  await renderEventosLateral();
  document.getElementById("panelArea").innerHTML = "";
  // render profesores small list
  renderProfesoresMini();
}

/* ---------------------------
   EVENTOS PANEL
   --------------------------- */
async function panelEventos(){
  const container = document.getElementById("panelArea");
  const eventos = loadLocal(KEY_EVENTOS, []);
  container.innerHTML = `
    <div class="panel">
      <h3>Gestionar Eventos</h3>
      <form id="formEvento">
        <input type="text" id="evName" placeholder="Nombre evento" required />
        <div style="display:flex;gap:6px;">
          <input type="time" id="evIni" required />
          <input type="time" id="evFin" required />
        </div>
        <button type="submit" class="small">Agregar evento</button>
      </form>
      <h4 style="margin-top:12px;">Eventos existentes</h4>
      <div id="listaEventos"></div>
    </div>
  `;
  const form = document.getElementById("formEvento");
  form.onsubmit = e => {
    e.preventDefault();
    let arr = loadLocal(KEY_EVENTOS, []);
    arr.push({ nombre: form.evName.value.trim(), ini: form.evIni.value, fin: form.evFin.value, id: Date.now() });
    saveLocal(KEY_EVENTOS, arr);
    panelEventos();
    renderEventosLateral();
  };

  const lista = document.getElementById("listaEventos");
  lista.innerHTML = "";
  eventos.forEach((ev,i) => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `<div><b>${ev.nombre}</b><div class="muted">${ev.ini} - ${ev.fin}</div></div>
      <div>
        <button class="small" onclick="delEvento(${ev.id})">‚ùå Borrar</button>
      </div>`;
    lista.appendChild(div);
  });
}

function delEvento(id){
  let arr = loadLocal(KEY_EVENTOS, []);
  arr = arr.filter(e => e.id !== id);
  saveLocal(KEY_EVENTOS, arr);
  panelEventos();
  renderEventosLateral();
}

async function renderEventosLateral(){
  const eventos = loadLocal(KEY_EVENTOS, []);
  const cont = document.getElementById("listaEventosLateral");
  cont.innerHTML = "";
  if(eventos.length === 0){
    cont.textContent = "No hay eventos. A√±ade eventos desde 'Eventos'.";
    return;
  }
  eventos.forEach(ev => {
    const d = document.createElement("div");
    d.textContent = `${ev.nombre} (${ev.ini}-${ev.fin})`;
    cont.appendChild(d);
  });
}

/* ---------------------------
   PROFESORES PANEL (editable)
   --------------------------- */
function panelProfesores(){
  const container = document.getElementById("panelArea");
  const profs = loadLocal(KEY_PROFES, []);
  container.innerHTML = `
    <div class="panel">
      <h3>Gestionar Profesores</h3>
      <div id="listaProfs"></div>
    </div>
  `;
  const lista = document.getElementById("listaProfs");
  lista.innerHTML = "";
  profs.forEach((p, idx) => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `<div><b>${p.nombre}</b><div class="muted">${p.email}</div></div>
      <div>
        <button class="small" onclick="delProf(${idx})">‚ùå</button>
      </div>`;
    lista.appendChild(div);
  });
}

document.getElementById("formAddProfesor").addEventListener("submit", e=>{
  e.preventDefault();
  const name = document.getElementById("profName").value.trim();
  const email = document.getElementById("profEmail").value.trim();
  if(!name || !email){ alert("Rellena nombre y correo"); return; }
  let arr = loadLocal(KEY_PROFES, []);
  arr.push({ nombre: name, email: email });
  saveLocal(KEY_PROFES, arr);
  document.getElementById("profName").value = "";
  document.getElementById("profEmail").value = "";
  panelProfesores();
  renderProfesoresMini();
});

function delProf(i){
  if(!confirm("¬øEliminar este profesor?")) return;
  let arr = loadLocal(KEY_PROFES, []);
  arr.splice(i,1);
  saveLocal(KEY_PROFES, arr);
  panelProfesores();
  renderProfesoresMini();
}

function renderProfesoresMini(){
  const wrap = document.getElementById("panelProfesoresContainer");
  const profs = loadLocal(KEY_PROFES, []);
  wrap.innerHTML = "";
  profs.forEach(p => {
    const d = document.createElement("div");
    d.className = "muted";
    d.textContent = `${p.nombre} ‚Äî ${p.email}`;
    wrap.appendChild(d);
  });
}

/* ---------------------------
   AUTORIZACIONES
   --------------------------- */
async function panelAutorizaciones(){
  const container = document.getElementById("panelArea");
  const profs = loadLocal(KEY_PROFES, []);
  const eventos = loadLocal(KEY_EVENTOS, []);
  container.innerHTML = `
    <div class="panel">
      <h3>Autorizaciones</h3>
      <p class="muted">Selecciona alumnos (m√∫ltiple), evento y uno o varios profesores. Se enviar√° un correo individual por cada combinaci√≥n alumno‚Üíprofesor.</p>
      <div style="margin-top:10px;">
        <h4>Alumnos</h4>
        <div id="alumnosList" class="checkbox-grid"></div>
      </div>
      <div style="margin-top:10px;">
        <h4>Evento</h4>
        <select id="eventoSelect">${eventos.length?eventos.map(ev=>`<option value="${ev.id}">${ev.nombre} (${ev.ini}-${ev.fin})</option>`).join("") : `<option value="">(Sin eventos)</option>`}</select>
      </div>
      <div style="margin-top:10px;">
        <h4>Profesores</h4>
        <div id="profesList" class="checkbox-grid"></div>
      </div>
      <div style="margin-top:12px;">
        <button id="sendAuth" class="small">Enviar autorizaciones</button>
      </div>
    </div>
  `;

  // render alumnos
  const alumnosWrap = document.getElementById("alumnosList");
  alumnosWrap.innerHTML = "";
  ALUMNOS.forEach((a, i) => {
    const id = `alumno_${i}`;
    const el = document.createElement("label");
    el.style = "display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;border:1px solid #eee;";
    el.innerHTML = `<input type="checkbox" id="${id}" value="${a}"><div>${a}</div>`;
    alumnosWrap.appendChild(el);
  });

  // render profesores
  const profsWrap = document.getElementById("profesList");
  profsWrap.innerHTML = "";
  profs.forEach((p, idx) => {
    const id = `prof_${idx}`;
    const el = document.createElement("label");
    el.style = "display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;border:1px solid #eee;";
    el.innerHTML = `<input type="checkbox" id="${id}" data-email="${p.email}" data-nombre="${p.nombre}"><div><b>${p.nombre}</b><div class="muted">${p.email}</div></div>`;
    profsWrap.appendChild(el);
  });

  document.getElementById("sendAuth").onclick = async () => {
    // selected alumnos
    const selectedAlumnos = [];
    ALUMNOS.forEach((a,i)=>{
      const cb = document.getElementById(`alumno_${i}`);
      if(cb && cb.checked) selectedAlumnos.push(a);
    });
    if(selectedAlumnos.length === 0){ alert("Selecciona al menos un alumno."); return; }

    // selected event
    const evId = document.getElementById("eventoSelect").value;
    if(!evId){ alert("Selecciona un evento."); return; }
    const evento = loadLocal(KEY_EVENTOS, []).find(e => String(e.id) === String(evId));
    if(!evento){ alert("Evento no encontrado."); return; }

    // selected profesores
    const profNodes = Array.from(document.querySelectorAll("#profesList input[type=checkbox]"));
    const selectedProfs = profNodes.filter(n => n.checked).map(n => ({ nombre: n.dataset.nombre, email: n.dataset.email }));
    if(selectedProfs.length === 0){ alert("Selecciona al menos un profesor."); return; }

    // Confirmar acci√≥n
    if(!confirm(`Vas a enviar ${selectedAlumnos.length * selectedProfs.length} correos (uno por cada alumno x profesor). ¬øContinuar?`)) return;

    // Enviar correos: UN correo individual por alumno√óprofesor
    const serviceId = "service_eb2pt87";
    const templateId = "template_0z24xrk";
    const promises = [];

    selectedAlumnos.forEach(alumno => {
      selectedProfs.forEach(prof => {
        // preparar params seg√∫n tu template original (ajusta campos si tu template espera otros)
        const templateParams = {
          to_email: prof.email,
          nombre: alumno,          // nombre del alumno
          clase: "",               // no tenemos clase en la lista fija; si quieres a√±adir, modifica ALUMNOS a objetos
          ini: evento.ini,
          fin: evento.fin,
          evento: evento.nombre
        };
        promises.push(
          emailjs.send(serviceId, templateId, templateParams)
            .then(()=> ({ status: "fulfilled", alumno, prof: prof.email }))
            .catch(err => ({ status: "rejected", alumno, prof: prof.email, error: err }))
        );
      });
    });

    // Esperar a que terminen todos
    const results = await Promise.all(promises);
    const ok = results.filter(r => r.status === "fulfilled").length;
    const fail = results.filter(r => r.status === "rejected").length;

    alert(`Envio completado. √âxitos: ${ok}. Fallos: ${fail}.`);
  };
}

/* ---------------------------
   Inicializaci√≥n autom√°tica: muestra panel Eventos al iniciar
   --------------------------- */
window.addEventListener("load", () => {
  // nada por defecto
});

/* ---------------------------
   Nota: Si quieres ampliar alumnos con 'clase' o 'profesor asignado', puedes
   cambiar ALUMNOS a un array de objetos: { nombre:"...", clase:"4¬∫ESO A", profesorEmail:"..." }
   y adaptar la UI. Por ahora queda simple para editar en la parte superior.
   --------------------------- */
</script>
</body>
</html>

</html>

