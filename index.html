<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alumnos Solidarios</title>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){
    emailjs.init("nXxJ4Ujpxo56o0BUT"); // Public Key
  })();
</script>

<style>
body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background: linear-gradient(135deg, red, yellow, orange);}
header {display:flex; justify-content: space-between; padding:15px 25px; font-weight:bold; color:black; font-size:20px; background: rgba(255,255,255,0.7);}
.login-container {height: calc(100% - 60px); display:flex; justify-content:center; align-items:center;}
.card {background:white; padding:20px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.3); width:320px; max-width:90%;}
.card input, .card button, select {width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc;}
.card button {background:black; color:white; cursor:pointer;}
.hidden {display:none;}
.app {padding:20px; display:flex; flex-wrap:wrap;}
#left {flex:1; min-width:250px; background: rgba(255,255,255,0.8); padding:15px; border-radius:10px; margin-right:20px;}
#right {flex:2; min-width:300px; display:flex; flex-direction: column; align-items:center;}
.btn {padding:20px; margin:10px; border:none; border-radius:10px; cursor:pointer; font-size:18px; width:80%; background:black; color:white;}
.btn:hover {background:#333;}
.panel {margin-top:20px; background:white; padding:15px; border-radius:10px; width:90%;}
.list-item {border-bottom:1px solid #ccc; padding:5px; display:flex; justify-content:space-between; flex-wrap:wrap;}
@media (max-width:768px) {.app {flex-direction:column;} #left {margin-right:0; margin-bottom:20px;}}
</style>
</head>
<body>
<header>
  <div>Voluntariado</div>
  <div>Alumnos Solidarios</div>
</header>

<!-- LOGIN -->
<div id="login" class="login-container">
  <div class="card">
    <h2>Iniciar Sesión</h2>
    <form id="loginForm">
      <input type="text" id="loginUser" placeholder="Usuario" required>
      <input type="password" id="loginPass" placeholder="Contraseña" required>
      <button type="submit">Entrar</button>
    </form>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h2 id="welcome" style="margin-left:20px;"></h2>
  <div class="app">
    <div id="left">
      <h3>Próximos Eventos</h3>
      <div id="listaEventosLateral"></div>
    </div>
    <div id="right">
      <!-- Botones Admin -->
      <div id="adminButtons" class="hidden">
        <button class="btn" onclick="panelUsuarios()">Usuarios</button>
        <button class="btn" onclick="panelProfesores()">Profesores</button>
        <button class="btn" onclick="panelEventos()">Eventos</button>
        <button class="btn" onclick="panelChatAdmin()">Chat</button>
        <button class="btn" onclick="panelAutorizaciones()">Autorizaciones</button>
        <button class="btn" onclick="panelCambiarContrasena()">Cambiar contraseña</button>
      </div>
      <!-- Botones Usuario -->
      <div id="userButtons" class="hidden">
        <button class="btn" onclick="panelEventosUsuario()">Próximos eventos</button>
        <button class="btn" onclick="panelChatUsuario()">Chat con Admin</button>
        <button class="btn" onclick="panelCambiarContrasena()">Cambiar contraseña</button>
      </div>
      <div id="panelArea"></div>
      <button onclick="logout()" class="btn" style="background:red;margin-top:20px;">Cerrar sesión</button>
    </div>
  </div>
</div>

<script>
const API_URL = "http://localhost:3000"; // Cambia a la URL de tu backend
const ADMINS = ["admin1","admin2"];
let currentUser = null;

// ==================== LOGIN ====================
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value.trim();
  if(ADMINS.includes(u)){
    // Login Admin: verifica contraseña via backend
    const res = await fetch(`${API_URL}/admin/login`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user:u, pass:p})
    });
    if(res.ok){currentUser={username:u, role:"Admin"}; startApp();}
    else alert("Usuario o contraseña incorrectos");
  } else {
    // Login usuario normal
    const res = await fetch(`${API_URL}/login`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({user:u, pass:p})
    });
    if(res.ok){
      currentUser = await res.json();
      currentUser.role = "User";
      startApp();
    } else alert("Usuario o contraseña incorrectos");
  }
});

function startApp(){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  const displayName = currentUser.role==="Admin"?currentUser.username:(currentUser.nombre||currentUser.user);
  document.getElementById("welcome").innerText = "Bienvenido, "+displayName;
  document.getElementById("adminButtons").classList.toggle("hidden", currentUser.role!=="Admin");
  document.getElementById("userButtons").classList.toggle("hidden", currentUser.role==="Admin");
  renderEventosLateral();
  document.getElementById("panelArea").innerHTML = "";
}

function logout(){location.reload();}

// ==================== FUNCIONES DE FETCH ====================
async function fetchAPI(endpoint, options={}){
  const res = await fetch(`${API_URL}${endpoint}`, options);
  if(res.ok) return await res.json();
  else return [];
}

// ==================== RENDER LATERAL ====================
async function renderEventosLateral(){
  const eventos = await fetchAPI("/eventos");
  const cont = document.getElementById("listaEventosLateral");
  cont.innerHTML = "";
  eventos.forEach(ev=>{
    const div = document.createElement("div");
    div.textContent = `${ev.nombre} (${ev.ini}-${ev.fin})`;
    cont.appendChild(div);
  });
}

// ==================== PANEL USUARIOS ====================
async function panelUsuarios(){
  const c = document.getElementById("panelArea");
  const usuarios = await fetchAPI("/usuarios");
  c.innerHTML = `<div class="panel">
    <h3>Gestionar Usuarios</h3>
    <form id="formUser">
      <input type="text" id="newUser" placeholder="Usuario" required>
      <input type="password" id="newPass" placeholder="Contraseña" required>
      <input type="text" id="nombre" placeholder="Nombre completo" required>
      <select id="clase">${["1ºESO","2ºESO","3ºESO","4ºESO"].map(curso=>Array.from({length:curso==="4ºESO"?4:5},(_,i)=>`${curso} ${String.fromCharCode(65+i)}`).map(op=>`<option>${op}</option>`).join("")).join("")}</select>
      <button type="submit">Agregar</button>
    </form>
    <div id="listaUsuarios"></div>
  </div>`;

  document.getElementById("formUser").onsubmit = async e=>{
    e.preventDefault();
    await fetch(`${API_URL}/usuarios`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        user:e.target.newUser.value,
        pass:e.target.newPass.value,
        nombre:e.target.nombre.value,
        clase:e.target.clase.value
      })
    });
    panelUsuarios();
  };

  const lista = document.getElementById("listaUsuarios");
  usuarios.forEach(u=>{
    const div = document.createElement("div");
    div.className="list-item";
    div.innerHTML=`${u.nombre} (${u.user}, ${u.clase}) <button onclick="eliminarUsuario('${u.user}')">❌</button>`;
    lista.appendChild(div);
  });
}

async function eliminarUsuario(user){
  await fetch(`${API_URL}/usuarios/${user}`,{method:"DELETE"});
  panelUsuarios();
}

// ==================== PANEL PROFESORES ====================
async function panelProfesores(){
  const c = document.getElementById("panelArea");
  const profs = await fetchAPI("/profesores");
  c.innerHTML=`<div class="panel">
    <h3>Gestionar Profesores</h3>
    <form id="formProf">
      <input type="text" id="profName" placeholder="Nombre Profesor" required>
      <input type="email" id="profMail" placeholder="Correo Profesor" required>
      <button type="submit">Agregar</button>
    </form>
    <div id="listaProfs"></div>
  </div>`;
  document.getElementById("formProf").onsubmit=async e=>{
    e.preventDefault();
    await fetch(`${API_URL}/profesores`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({nombre:e.target.profName.value,email:e.target.profMail.value})
    });
    panelProfesores();
  };
  const lista=document.getElementById("listaProfs");
  profs.forEach(p=>{
    const div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`${p.nombre} (${p.email}) <button onclick="eliminarProfesor('${p.email}')">❌</button>`;
    lista.appendChild(div);
  });
}

async function eliminarProfesor(email){
  await fetch(`${API_URL}/profesores/${email}`,{method:"DELETE"});
  panelProfesores();
}

// ==================== PANEL EVENTOS ====================
async function panelEventos(){
  const c=document.getElementById("panelArea");
  const eventos = await fetchAPI("/eventos");
  c.innerHTML=`<div class="panel">
    <h3>Gestionar Eventos</h3>
    <form id="formEvento">
      <input type="text" id="evName" placeholder="Nombre evento" required>
      <input type="time" id="evIni" required> a <input type="time" id="evFin" required>
      <button type="submit">Agregar</button>
    </form>
    <div id="listaEventos"></div>
  </div>`;
  document.getElementById("formEvento").onsubmit=async e=>{
    e.preventDefault();
    await fetch(`${API_URL}/eventos`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({nombre:e.target.evName.value,ini:e.target.evIni.value,fin:e.target.evFin.value,asistencias:[]})
    });
    panelEventos();
    renderEventosLateral();
  };
  const lista=document.getElementById("listaEventos");
  eventos.forEach((ev)=>{
    const div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`<b>${ev.nombre}</b> ${ev.ini}-${ev.fin} <button onclick="eliminarEvento('${ev.nombre}')">❌</button>`;
    lista.appendChild(div);
  });
}

async function eliminarEvento(nombre){
  await fetch(`${API_URL}/eventos/${nombre}`,{method:"DELETE"});
  panelEventos();
  renderEventosLateral();
}

// ==================== CAMBIAR CONTRASEÑA ====================
async function panelCambiarContrasena(){
  const c = document.getElementById("panelArea");
  c.innerHTML=`<div class="panel">
    <h3>Cambiar Contraseña</h3>
    <form id="formPass">
      <input type="password" id="oldPass" placeholder="Contraseña actual" required>
      <input type="password" id="newPass1" placeholder="Nueva contraseña" required>
      <input type="password" id="newPass2" placeholder="Repetir nueva contraseña" required>
      <button type="submit">Cambiar</button>
    </form>
  </div>`;
  document.getElementById("formPass").onsubmit=async e=>{
    e.preventDefault();
    const oldP = e.target.oldPass.value;
    const new1 = e.target.newPass1.value;
    const new2 = e.target.newPass2.value;
    if(new1!==new2){alert("Las contraseñas no coinciden"); return;}
    const res = await fetch(`${API_URL}/usuarios/${currentUser.user}/pass`,{
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({oldPass:oldP,newPass:new1})
    });
    if(res.ok) alert("Contraseña cambiada"); else alert("Error al cambiar contraseña");
  }
}
</script>
</body>
</html>
