<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alumnos Solidarios — Admin</title>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){
    emailjs.init("nXxJ4Ujpxo56o0BUT"); // Public Key (igual que antes)
  })();
</script>

<style>
body, html { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:linear-gradient(135deg, red, yellow, orange); }
header { display:flex; justify-content:space-between; padding:15px 25px; font-weight:bold; color:black; font-size:20px; background:rgba(255,255,255,0.8); }
.login-container { height:calc(100% - 60px); display:flex; justify-content:center; align-items:center; }
.card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.3); width:360px; max-width:95%; }
.card input, .card button, select, textarea { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
.card button { background:black; color:white; cursor:pointer; border:none; }
.hidden { display:none; }
.app { padding:20px; display:flex; flex-wrap:wrap; }
#left { flex:1; min-width:260px; background:rgba(255,255,255,0.9); padding:15px; border-radius:10px; margin-right:20px; }
#right { flex:2; min-width:340px; display:flex; flex-direction:column; align-items:center; }
.btn { padding:14px; margin:8px; border:none; border-radius:10px; cursor:pointer; font-size:16px; width:85%; background:black; color:white; }
.btn:hover { background:#333; }
.panel { margin-top:20px; background:white; padding:15px; border-radius:10px; width:95%; box-sizing:border-box; }
.list-item { border-bottom:1px solid #ccc; padding:8px; display:flex; justify-content:space-between; flex-wrap:wrap; align-items:center; }
.muted { color:#666; font-size:14px; }
@media (max-width:768px){ .app{ flex-direction:column; } #left{ margin-right:0; margin-bottom:20px; } }
.small { font-size:13px; padding:6px 8px; }
.checkbox-grid { display:grid; gap:6px; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); }
</style>
</head>
<body>
<header>
  <div>Voluntariado</div>
  <div>Alumnos Solidarios — Admin</div>
</header>

<!-- LOGIN -->
<div id="login" class="login-container">
  <div class="card">
    <h2>Iniciar Sesión (Admin)</h2>
    <form id="loginForm">
      <input type="text" id="loginUser" placeholder="Usuario" required />
      <input type="password" id="loginPass" placeholder="Contraseña" required />
      <button type="submit">Entrar</button>
    </form>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h2 id="welcome" style="margin-left:20px;"></h2>
  <div class="app">
    <div id="left">
      <h3>Próximos Eventos</h3>
      <div id="listaEventosLateral" class="muted"></div>
      <div class="panel" style="margin-top:12px;">
        <h3>Profesores (panel)</h3>
        <div id="panelProfesoresContainer"></div>
        <hr>
        <h4>Añadir profesor</h4>
        <form id="formAddProfesor">
          <input type="text" id="profName" placeholder="Nombre profesor" required />
          <input type="email" id="profEmail" placeholder="Correo profesor" required />
          <button type="submit" class="small">Agregar profesor</button>
        </form>
      </div>
    </div>

    <div id="right">
      <div id="adminButtons">
        <button class="btn" onclick="panelEventos()">Eventos</button>
        <button class="btn" onclick="panelProfesores()">Profesores</button>
        <button class="btn" onclick="panelAutorizaciones()">Autorizaciones</button>
      </div>

      <div id="panelArea" style="width:100%;"></div>

      <button onclick="logout()" class="btn" style="background:red;margin-top:20px;">Cerrar sesión</button>
    </div>
  </div>
</div>

<script>
/* ---------------- CONFIGURACIÓN EDITABLE ---------------- */
const ALUMNOS = [
"JUAN ALCAIDE ORTEGA","IGNACIO ALONSO FERNÁNDEZ","ANA APARICIO DE DIEGO",
"BLANCA ARÍAS LOMAS","NOA ASENSIO LEGIDO","ISABELLA BENTO RUIZ","EMMA BERMÚDEZ LÓPEZ",
"cyan blaise velasquez","Asier Bocardo Melguizo","SOFÍA BRAVO TEJERO",
"MAR SARAY CÁCERES FLORES","ARIADNE CALDERÓN PÉREZ","DANIELA CAÑETE LÓPEZ",
"MARÍA COBOS BENEDICTO","IVAN CORREIA NARROS","ALEJANDRO DE BLAS LÓPEZ-EGEA",
"ADRIÁN DELGADO GONZALEZ","PABLO DUY DÍAZ SANTÍN","SOFÍA DÍAZ-PACHE ROJAS",
"VEGA EGEA ARO","SARA FERNÁNDEZ BUITRAGO","RUTH FERNÁNDEZ GONZALO",
"César Fernández Zarco","MARCOS GARCÍA BARTOLOMÉ","BLANCA GARCÍA ESTEBAN",
"DANIELA GARCÍA GÓMEZ","Hugo García González","VÍCTOR GARCÍA RAMÍREZ",
"MARÍA GÓMEZ CARMONA","MÓNICA GUTIÉRREZ ROMÁN","MARÍA HERRÁEZ MARTÍNEZ",
"EMMA HERRERO BENITO","EMMA HUERTAS LÓPEZ","SARA LEONARDO GARCÍA",
"Aini Li","Dimas López","ELENA MARTÍNEZ BAÑÓN","NOA MARTÍNEZ HURTADO",
"DANIEL ORTE GÓMEZ","GUILLERMO PALACIOS ASPIAZU (guiso)","LUCÍA PÉREZ GALIANA",
"MARCELA RAMOS GUDÍN","LIA RODRÍGUEZ SIERRA","ANDRÉS ROMERO OCHOA",
"CLAUDIA JING XIAN RUAN","Isabela RUBIO PARRA","DOMENIKOS SALAZAR BALLI",
"PRITHIKA THIRUNAVUKKARASU","SOFÍA TORRES FERNÁNDEZ","ERIKA VÁZQUEZ SÁNCHEZ",
"CLAUDIA VERA CANTALAPIEDRA","CARLA VIVAR DEL CASTILLO","LUCAS WILT ESCRIBANO",
"Angela Xia","MINGHAO XU","WAN YUE YANG","YINGZHAO ZHOU"
];

const INITIAL_PROFESORES = [
  { nombre: "Juan José", email: "juanjose@iepgroup.es" },
  { nombre: "Susana de Diego", email: "susana.dediego@iepgroup.es" },
  { nombre: "Elena Covadonga", email: "elena.covadonga@iepgroup.es" },
  { nombre: "Elena Ovejero", email: "elena.ovejero@iepgroup.es" },
  { nombre: "José Luis Arriaga", email: "jose.luis.arriaga@iepgroup.es" },
  { nombre: "Ascensión Liébana", email: "ascension.liebana@iepgroup.es" },
  { nombre: "Ana López", email: "ana.lopez@iepgroup.es" },
  { nombre: "José Luis Herrero", email: "joseluis.herrero@iepgroup.es" },
  { nombre: "Antonio Liébana", email: "antonio.liebana@iepgroup.es" },
  { nombre: "Mónica Juárez", email: "monica.juarez@iepgroup.es" },
  { nombre: "Óscar Partida", email: "oscar.partida@iepgroup.es" }
];

/* ---------------- CONFIGURACIÓN ADMIN ---------------- */
const ADMINS = ["admin1","admin2"];
const ADMIN_PASS = "Solidarios25";
const KEY_PROFES = "as_profesores_v1";
const KEY_EVENTOS = "as_eventos_v1";

function loadLocal(key,fallback){ try{ return JSON.parse(localStorage.getItem(key))||fallback; }catch(e){ return fallback; } }
function saveLocal(key,val){ localStorage.setItem(key,JSON.stringify(val)); }

if(!loadLocal(KEY_PROFES,null)) saveLocal(KEY_PROFES,INITIAL_PROFESORES);
if(!loadLocal(KEY_EVENTOS,null)) saveLocal(KEY_EVENTOS,[]);

let currentUser = null;

/* ---------------- LOGIN ---------------- */
document.getElementById("loginForm").addEventListener("submit", e=>{
  e.preventDefault();
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value.trim();
  if(ADMINS.includes(u) && p===ADMIN_PASS){
    currentUser={username:u,role:"Admin"};
    startApp();
  } else { alert("Usuario o contraseña incorrectos"); }
});

function logout(){ location.reload(); }

async function startApp(){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  document.getElementById("welcome").innerText="Bienvenido, "+currentUser.username;
  renderEventosLateral();
  panelEventos(); // panel inicial
  renderProfesoresMini();
}

/* ---------------- PANEL EVENTOS ---------------- */
function panelEventos(){
  const container = document.getElementById("panelArea");
  const eventos = loadLocal(KEY_EVENTOS,[]);
  container.innerHTML = `
    <div class="panel">
      <h3>Gestionar Eventos</h3>
      <form id="formEvento">
        <input type="text" id="evName" placeholder="Nombre evento" required />
        <div style="display:flex;gap:6px;">
          <input type="time" id="evIni" required />
          <input type="time" id="evFin" required />
        </div>
        <button type="submit" class="small">Agregar evento</button>
      </form>
      <h4 style="margin-top:12px;">Eventos existentes</h4>
      <div id="listaEventos"></div>
    </div>
  `;
  const form = document.getElementById("formEvento");
  form.onsubmit = e=>{
    e.preventDefault();
    let arr = loadLocal(KEY_EVENTOS,[]);
    arr.push({nombre:form.evName.value.trim(),ini:form.evIni.value,fin:form.evFin.value,id:Date.now()});
    saveLocal(KEY_EVENTOS,arr);
    panelEventos();
    renderEventosLateral();
  };
  const lista = document.getElementById("listaEventos");
  lista.innerHTML = "";
  eventos.forEach(ev=>{
    const div = document.createElement("div");
    div.className="list-item";
    div.innerHTML = `<div><b>${ev.nombre}</b><div class="muted">${ev.ini} - ${ev.fin}</div></div>
      <div><button class="small" onclick="delEvento(${ev.id})">❌ Borrar</button></div>`;
    lista.appendChild(div);
  });
}

function delEvento(id){
  let arr = loadLocal(KEY_EVENTOS,[]);
  arr = arr.filter(e=>e.id!==id);
  saveLocal(KEY_EVENTOS,arr);
  panelEventos();
  renderEventosLateral();
}

function renderEventosLateral(){
  const eventos = loadLocal(KEY_EVENTOS,[]);
  const cont = document.getElementById("listaEventosLateral");
  cont.innerHTML="";
  if(eventos.length===0){ cont.textContent="No hay eventos. Añade eventos desde 'Eventos'."; return; }
  eventos.forEach(ev=>{
    const d=document.createElement("div");
    d.textContent=`${ev.nombre} (${ev.ini}-${ev.fin})`;
    cont.appendChild(d);
  });
}

/* ---------------- PANEL PROFESORES ---------------- */
function panelProfesores(){
  const container=document.getElementById("panelArea");
  const profs = loadLocal(KEY_PROFES,[]);
  container.innerHTML = `<div class="panel"><h3>Gestionar Profesores</h3><div id="listaProfs"></div></div>`;
  const lista=document.getElementById("listaProfs");
  lista.innerHTML="";
  profs.forEach((p,idx)=>{
    const div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`<div><b>${p.nombre}</b><div class="muted">${p.email}</div></div>
      <div><button class="small" onclick="delProf(${idx})">❌</button></div>`;
    lista.appendChild(div);
  });
}

document.getElementById("formAddProfesor").addEventListener("submit", e=>{
  e.preventDefault();
  const name=document.getElementById("profName").value.trim();
  const email=document.getElementById("profEmail").value.trim();
  if(!name || !email){ alert("Rellena nombre y correo"); return; }
  let arr = loadLocal(KEY_PROFES,[]);
  arr.push({nombre:name,email:email});
  saveLocal(KEY_PROFES,arr);
  document.getElementById("profName").value="";
  document.getElementById("profEmail").value="";
  panelProfesores();
  renderProfesoresMini();
});

function delProf(i){
  if(!confirm("¿Eliminar este profesor?")) return;
  let arr = loadLocal(KEY_PROFES,[]);
  arr.splice(i,1);
  saveLocal(KEY_PROFES,arr);
  panelProfesores();
  renderProfesoresMini();
}

function renderProfesoresMini(){
  const wrap=document.getElementById("panelProfesoresContainer");
  const profs = loadLocal(KEY_PROFES,[]);
  wrap.innerHTML="";
  profs.forEach(p=>{
    const d=document.createElement("div");
    d.className="muted";
    d.textContent=`${p.nombre} — ${p.email}`;
    wrap.appendChild(d);
  });
}

/* ---------------- PANEL AUTORIZACIONES ---------------- */
function panelAutorizaciones(){
  const container=document.getElementById("panelArea");
  const profs=loadLocal(KEY_PROFES,[]);
  const eventos=loadLocal(KEY_EVENTOS,[]);
  container.innerHTML=`
    <div class="panel">
      <h3>Autorizaciones</h3>
      <p class="muted">Selecciona alumnos (múltiple), evento y uno o varios profesores. Se enviará un correo individual por cada combinación alumno→profesor.</p>
      <div style="margin-top:10px;">
        <h4>Alumnos</h4>
        <div id="alumnosList" class="checkbox-grid"></div>
      </div>
      <div style="margin-top:10px;">
        <h4>Evento</h4>
        <select id="eventoSelect">${eventos.length?eventos.map(ev=>`<option value="${ev.id}">${ev.nombre} (${ev.ini}-${ev.fin})</option>`).join(""):`<option value="">(Sin eventos)</option>`}</select>
      </div>
      <div style="margin-top:10px;">
        <h4>Profesores</h4>
        <div id="profesList" class="checkbox-grid"></div>
      </div>
      <div style="margin-top:12px;">
        <button id="sendAuth" class="small">Enviar autorizaciones</button>
      </div>
    </div>
  `;

  // render alumnos
  const alumnosWrap=document.getElementById("alumnosList");
  alumnosWrap.innerHTML="";
  ALUMNOS.forEach((a,i)=>{
    const id=`alumno_${i}`;
    const el=document.createElement("label");
    el.style="display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;border:1px solid #eee;";
    el.innerHTML=`<input type="checkbox" id="${id}" value="${a}"><div>${a}</div>`;
    alumnosWrap.appendChild(el);
  });

  // render profesores
  const profsWrap=document.getElementById("profesList");
  profsWrap.innerHTML="";
  profs.forEach((p,idx)=>{
    const id=`prof_${idx}`;
    const el=document.createElement("label");
    el.style="display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;border:1px solid #eee;";
    el.innerHTML=`<input type="checkbox" id="${id}" data-email="${p.email}" data-nombre="${p.nombre}"><div><b>${p.nombre}</b><div class="muted">${p.email}</div></div>`;
    profsWrap.appendChild(el);
  });

  document.getElementById("sendAuth").onclick=async()=>{
    const selectedAlumnos=[];
    ALUMNOS.forEach((a,i)=>{ const cb=document.getElementById(`alumno_${i}`); if(cb && cb.checked) selectedAlumnos.push(a); });
    if(selectedAlumnos.length===0){ alert("Selecciona al menos un alumno."); return; }

    const evId=document.getElementById("eventoSelect").value;
    if(!evId){ alert("Selecciona un evento."); return; }
    const evento=eventos.find(e=>String(e.id)===String(evId));
    if(!evento){ alert("Evento no encontrado."); return; }

    const profNodes=Array.from(document.querySelectorAll("#profesList input[type=checkbox]"));
    const selectedProfs=profNodes.filter(n=>n.checked).map(n=>({nombre:n.dataset.nombre,email:n.dataset.email}));
    if(selectedProfs.length===0){ alert("Selecciona al menos un profesor."); return; }

    if(!confirm(`Vas a enviar ${selectedAlumnos.length*selectedProfs.length} correos. ¿Continuar?`)) return;

    const serviceId="service_eb2pt87";
    const templateId="template_0z24xrk";
    const promises=[];
    selectedAlumnos.forEach(alumno=>{ selectedProfs.forEach(prof=>{
      const templateParams={to_email:prof.email,nombre:alumno,clase:"",ini:evento.ini,fin:evento.fin,evento:evento.nombre};
      promises.push(emailjs.send(serviceId,templateId,templateParams)
        .then(()=>({status:"fulfilled",alumno,prof:prof.email}))
        .catch(err=>({status:"rejected",alumno,prof:prof.email,error:err})));
    });});
    const results=await Promise.all(promises);
    const ok=results.filter(r=>r.status==="fulfilled").length;
    const fail=results.filter(r=>r.status==="rejected").length;
    alert(`Envio completado. Éxitos: ${ok}. Fallos: ${fail}.`);
  };
}
</script>
</body>
</html>




