<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alumnos Solidarios</title>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  (function(){ emailjs.init("nXxJ4Ujpxo56o0BUT"); })();
</script>

<style>
body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif;
  background: linear-gradient(135deg, red, yellow, orange); }
header { display: flex; justify-content: space-between; padding: 15px 25px;
  font-weight: bold; color: black; font-size: 20px; background: rgba(255,255,255,0.7); }
.login-container { height: calc(100% - 60px); display: flex; justify-content: center; align-items: center; }
.card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); width: 320px; max-width: 90%; }
.card input, .card button, select { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; }
.card button { background: black; color: white; cursor: pointer; }
.hidden { display: none; }
.app { padding: 20px; display: flex; flex-wrap: wrap; }
#left { flex: 1; min-width: 250px; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; margin-right: 20px; }
#right { flex: 2; min-width: 300px; display: flex; flex-direction: column; align-items: center; }
.btn { padding: 20px; margin: 10px; border: none; border-radius: 10px; cursor: pointer; font-size: 18px; width: 80%; background: black; color: white; }
.btn:hover { background: #333; }
.panel { margin-top: 20px; background: white; padding: 15px; border-radius: 10px; width: 90%; }
.list-item { border-bottom: 1px solid #ccc; padding: 5px; display: flex; justify-content: space-between; flex-wrap: wrap; }
@media (max-width: 768px) { .app { flex-direction: column; } #left { margin-right: 0; margin-bottom: 20px; } }
</style>
</head>
<body>
<header>
  <div>Voluntariado</div>
  <div>Alumnos Solidarios</div>
</header>

<!-- LOGIN -->
<div id="login" class="login-container">
  <div class="card">
    <h2>Iniciar Sesión</h2>
    <form id="loginForm">
      <input type="text" id="loginUser" placeholder="Usuario" required>
      <input type="password" id="loginPass" placeholder="Contraseña" required>
      <button type="submit">Entrar</button>
    </form>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <h2 id="welcome" style="margin-left:20px;"></h2>
  <div class="app">
    <div id="left">
      <h3>Próximos Eventos</h3>
      <div id="listaEventosLateral"></div>
    </div>
    <div id="right">
      <!-- Botones Admin -->
      <div id="adminButtons" class="hidden">
        <button class="btn" onclick="panelUsuarios()">Usuarios</button>
        <button class="btn" onclick="panelProfesores()">Profesores</button>
        <button class="btn" onclick="panelEventos()">Eventos</button>
        <button class="btn" onclick="panelChatAdmin()">Chat</button>
        <button class="btn" onclick="panelAutorizaciones()">Autorizaciones</button>
        <button class="btn" onclick="panelCambioPass()">Cambiar Contraseña</button>
      </div>
      <!-- Botones Usuario -->
      <div id="userButtons" class="hidden">
        <button class="btn" onclick="panelEventosUsuario()">Próximos eventos</button>
        <button class="btn" onclick="panelChatUsuario()">Chat con Admin</button>
        <button class="btn" onclick="panelCambioPass()">Cambiar Contraseña</button>
      </div>
      <div id="panelArea"></div>
      <button onclick="logout()" class="btn" style="background:red;margin-top:20px;">Cerrar sesión</button>
    </div>
  </div>
</div>

<script>
let currentUser=null;
const ADMIN_USERS=["admin1","admin2"];
const ADMIN_PASS_DEFAULT="Solidarios25";

async function fetchAPI(path, options){ 
  const res=await fetch('http://localhost:3000'+path, options);
  if(res.status!==204) return res.json(); else return null;
}

// LOGIN
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const u=document.getElementById("loginUser").value.trim();
  const p=document.getElementById("loginPass").value.trim();
  if(ADMIN_USERS.includes(u) && p===ADMIN_PASS_DEFAULT){
    currentUser={username:u, role:"Admin"};
    startApp();
    return;
  }
  const usuarios=await fetchAPI('/usuarios');
  const user=usuarios.find(x=>x.user===u && x.pass===p);
  if(user){ currentUser={...user, role:"User"}; startApp(); }
  else alert("Usuario o contraseña incorrectos");
});

function startApp(){
  document.getElementById("login").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  const displayName=currentUser.role==="Admin"?currentUser.username:(currentUser.nombre||currentUser.user);
  document.getElementById("welcome").innerText="Bienvenido, "+displayName;
  document.getElementById("adminButtons").classList.toggle("hidden", currentUser.role!=="Admin");
  document.getElementById("userButtons").classList.toggle("hidden", currentUser.role==="Admin");
  renderEventosLateral();
  document.getElementById("panelArea").innerHTML="";
}

function logout(){ location.reload(); }

/* ===== CAMBIO DE CONTRASEÑA ===== */
function panelCambioPass(){
  const c=document.getElementById("panelArea");
  c.innerHTML=`
    <div class="panel">
      <h3>Cambiar Contraseña</h3>
      <form id="formPass">
        <input type="password" id="oldPass" placeholder="Contraseña actual" required>
        <input type="password" id="newPass" placeholder="Nueva contraseña" required>
        <input type="password" id="newPass2" placeholder="Confirmar nueva contraseña" required>
        <button type="submit">Actualizar</button>
      </form>
    </div>
  `;
  document.getElementById("formPass").onsubmit=async e=>{
    e.preventDefault();
    const oldP=document.getElementById("oldPass").value;
    const newP=document.getElementById("newPass").value;
    const newP2=document.getElementById("newPass2").value;
    if(newP!==newP2){ alert("Las nuevas contraseñas no coinciden"); return; }
    if(currentUser.role==="Admin"){
      if(oldP!==ADMIN_PASS_DEFAULT){ alert("Contraseña actual incorrecta"); return; }
      alert("✅ Contraseña de admin cambiada (reinicie la app para persistir)");
    } else {
      await fetchAPI(`/usuarios/${currentUser.user}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({pass:newP})
      });
      alert("✅ Contraseña actualizada");
    }
  };
}

/* ===== PANEL USUARIOS ===== */
async function panelUsuarios(){
  const c = document.getElementById("panelArea");
  const usuarios=await fetchAPI('/usuarios');
  c.innerHTML=`
    <div class="panel">
      <h3>Gestionar Usuarios</h3>
      <form id="formUser">
        <input type="text" id="newUser" placeholder="Usuario" required>
        <input type="password" id="newPass" placeholder="Contraseña" required>
        <input type="text" id="nombre" placeholder="Nombre completo" required>
        <select id="clase">
          ${["1ºESO","2ºESO","3ºESO","4ºESO"].map(curso=>
            Array.from({length:curso==="4ºESO"?4:5},(_,i)=>`${curso} ${String.fromCharCode(65+i)}`)
            .map(op=>`<option>${op}</option>`).join("")
          ).join("")}
        </select>
        <button type="submit">Agregar</button>
      </form>
      <h4>Usuarios existentes</h4>
      <div id="listaUsuarios"></div>
    </div>
  `;
  document.getElementById("formUser").onsubmit=async e=>{
    e.preventDefault();
    const form=e.target;
    await fetchAPI('/usuarios', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        user:form.newUser.value, pass:form.newPass.value,
        nombre:form.nombre.value, clase:form.clase.value
      })
    });
    panelUsuarios();
  };
  const lista=document.getElementById("listaUsuarios");
  usuarios.forEach(u

